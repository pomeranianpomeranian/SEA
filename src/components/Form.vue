<template>
  <b-container>
    <b-form-row>
      <b-form class="col-8 offset-2">
        <b-form-group :label="`${$t('form.title')} :`" label-for="title">
          <b-form-input
            id="title"
            type="text"
            :placeholder="$t('placeholder.title')"
            v-model="postContents.title"
            required
          ></b-form-input>
        </b-form-group>

        <b-form-group :label="`${$t('form.category')} :`" label-for="category">
          <b-input-group>
            <b-form-select
              id="category"
              :options="categories"
              v-model="selected"
              required
            ></b-form-select>
            <b-input-group-append>
              <b-button variant="outline-success" @click="addCategory">{{
                $t("form.add")
              }}</b-button>
            </b-input-group-append>
          </b-input-group>
          <div class="categories-list my-2 p-1">
            <span>{{ $t("form.selected") }}</span>
            <span
              class="category p-1 mx-1"
              v-for="(category, index) in postContents.categories"
              :key="index"
              @click="deleteCategory(index)"
            >
              {{ $t(`category.${category}`) }}
            </span>
          </div>
        </b-form-group>

        <b-form-group
          :label="`${$t('form.description')} :`"
          label-for="description"
        >
          <b-form-textarea
            id="description"
            :placeholder="$t('placeholder.description')"
            v-model="postContents.description"
            rows="3"
            max-rows="6"
            required
          ></b-form-textarea>
        </b-form-group>

        <b-form-group :label="`${$t('form.image')} :`" label-for="images">
          <b-form-file
            id="images"
            accept=".jpg, .jpeg, .png"
            :placeholder="$t('placeholder.image')"
            @change.self="storeImage"
            required
          ></b-form-file>
        </b-form-group>

        <p class="mb-2">{{ $t("form.preview") }}</p>
        <b-container class="img-container">
          <p v-if="postContents.imagesRef.length">
            {{ $t("placeholder.delete") }}
          </p>
          <b-row v-if="postContents.imagesRef.length">
            <b-col
              cols="6"
              v-for="(image, index) in postContents.imagesRef"
              :key="index"
              @click="deleteImage(index)"
            >
              <b-img :src="image.url" fluid thumbnail />
            </b-col>
          </b-row>
        </b-container>

        <p class="mt-3 mb-2">{{ $t("form.location") }}</p>
        <GmapMap
          class=""
          :center="currentPosition"
          :zoom="10"
          map-type-id="terrain"
          style="width: 100%; height: 600px"
          @click="getPosition($event)"
        >
          <GmapInfoWindow
            :options="infoOptions"
            :position="postContents.position"
            :opened="infoWinOpen"
            @closeclick="infoWinOpen = false"
          >
            {{ windowTitle }}</GmapInfoWindow
          >
          <GmapMarker
            :key="index"
            v-for="(m, index) in markers"
            :position="m.position"
            :clickable="true"
            :draggable="true"
            @click="toggleInfoWindow(m.position)"
          />
        </GmapMap>

        <div class="mt-3" v-if="$route.name === 'newpost'">
          <b-button
            class="col-6"
            variant="outline-info"
            type="button"
            size="lg"
            @click="submitPost(false)"
            v-bind="{ disabled: !completed }"
            >{{ $t("form.submit") }}</b-button
          >
          <b-button
            class="col-6"
            variant="outline-dark"
            type="button"
            size="lg"
            @click="submitPost(true)"
            v-bind="{ disabled: !completed }"
            >{{ $t("form.save") }}</b-button
          >
        </div>
        <div class="mt-3" v-if="$route.name === 'edit'">
          <b-button
            class="col"
            variant="outline-info"
            type="button"
            size="lg"
            @click="updatePost"
            v-bind="{ disabled: !completed }"
            >{{ $t("form.update") }}</b-button
          >
        </div>
      </b-form>
    </b-form-row>
  </b-container>
</template>

<script>
import { mapActions } from "vuex";
export default {
  data() {
    return {
      windowTitle: "hoge",
      selected: "",
      categories: [
        { value: "", text: this.$t("placeholder.category"), disabled: true },
        { value: "culture", text: this.$t("category.culture") },
        { value: "nature", text: this.$t("category.nature") },
        { value: "amusement", text: this.$t("category.amusement") },
        { value: "food", text: this.$t("category.food") },
        { value: "shopping", text: this.$t("category.shopping") },
        { value: "history", text: this.$t("category.history") },
        { value: "sports", text: this.$t("category.sports") },
        { value: "view", text: this.$t("category.view") },
      ],
      currentPosition: {},
      markers: [],
      infoOptions: {
        pixelOffset: {
          width: 0,
          height: -35,
        },
      },
      infoWindowPos: null,
      infoWinOpen: false,
    };
  },
  methods: {
    ...mapActions(["deleteImage", "storeImage", "submitPost", "updatePost"]),
    addCategory() {
      if (!this.postContents.categories.includes(this.selected)) {
        this.postContents.categories.push(this.selected);
      }
    },
    deleteCategory(index) {
      this.postContents.categories.splice(index, 1);
    },
    toggleInfoWindow(position) {
      this.postContents.position = position;
      this.infoWinOpen = true;
    },
    getPosition: function (event) {
      if (this.markers.length >= 1) {
        this.markers.splice(1);
      }
      if (event) {
        this.markers.push({
          id: this.markers.length,
          title: this.postContents.title,
          infowWindow: true,
          position: { lat: event.latLng.lat(), lng: event.latLng.lng() },
        });
      }
      this.windowTitle = this.postContents.title;
      this.toggleInfoWindow({
        lat: event.latLng.lat(),
        lng: event.latLng.lng(),
      });
    },
  },
  created() {
    this.$getLocation().then((coordinates) => {
      this.currentPosition = coordinates;
      this.markers.push({
        position: this.currentPosition,
      });
    });
    this.$store.commit("clearContents");
  },
  computed: {
    postContents() {
      return this.$store.state.post.postContents;
    },
    completed() {
      if (
        this.postContents.title &&
        this.postContents.description &&
        this.postContents.categories.length &&
        this.postContents.imagesRef.length &&
        this.postContents.position
      )
        return true;
      else return false;
    },
  },
};
</script>

<style scoped>
.img-container {
  border: 1px solid lightgray;
  border-radius: 0.3rem;
  min-height: 15rem;
  max-height: 30rem;
}
img {
  cursor: pointer;
}
.categories-list {
  border: 1px solid lightgray;
  border-radius: 0.2rem;
}
.category {
  font-weight: bold;
  cursor: pointer;
}
</style>
